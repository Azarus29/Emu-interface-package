"use strict";function SpectroDrawingWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}angular.module("EMUInterface",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).otherwise({redirectTo:"/"})}]).config(["$locationProvider",function(a){a.hashPrefix("")}]),SpectroDrawingWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){a.executed=!1,a.PI=3.141592653589793,a.TWO_PI=6.283185307179586,a.totalMax=0,a.dynRangeInDB=50,a.myWindow={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},a.imgWidth=0,a.imgHeight=0,a.upperFreq=0,a.lowerFreq=0,a.pixelRatio=1,a.heatMapColorAnchors=[[255,0,0],[0,255,0],[0,0,0]],a.samplesPerPxl=0,a.sampleRate=0,a.preEmphasisFilterFactor=.97,a.transparency=0,a.drawHeatMapColors=!1,a.N=0,a.windowSizeInSecs=.01,a.audioBuffer=void 0,a.audioBufferChannels=0,a.wFunction=0,a.myFFT=void 0,a.pixelHeight=1,a.internalalpha=1,a.maxPsd=0,a.HzStep=0,a.paint=[],a.sin=void 0,a.cos=void 0,a.ceilingFreqFftIdx=0,a.floorFreqFftIdx=0,a.resultImgArr=void 0,a.toLinearLevel=function(a){return Math.pow(10,a/10)},a.log10=function(a){return Math.log(a)/2.302585092994046},a.magnitude=function(a,b){return Math.sqrt(a*a+b*b)},a.FFT=function(){var b,c,d,e=a.N;if(b=parseInt(Math.log(e)/.6931471805599453,10),void 0===a.cos||e!==a.N)for(a.cos=new Float32Array(e/2),d=0;e/2>d;d++)a.cos[d]=Math.cos(-2*a.PI*d/e);if(void 0===a.sin||e!==a.N)for(a.sin=new Float32Array(e/2),d=0;e/2>d;d++)a.sin[d]=Math.sin(-2*a.PI*d/e);this.applyWindowFuncAndPreemph=function(b,d,e,f){switch(this.alpha=d,b){case a.myWindow.BARTLETT:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBartlett(f,c);break;case a.myWindow.BARTLETTHANN:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBartlettHann(f,c);break;case a.myWindow.BLACKMAN:for(this.alpha=this.alpha||.16,c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBlackman(f,c,d);break;case a.myWindow.COSINE:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionCosine(f,c);break;case a.myWindow.GAUSS:for(this.alpha=this.alpha||.25,c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionGauss(f,c,d);break;case a.myWindow.HAMMING:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionHamming(f,c);break;case a.myWindow.HANN:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionHann(f,c);break;case a.myWindow.LANCZOS:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionLanczos(f,c);break;case a.myWindow.RECTANGULAR:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionRectangular(f,c);break;case a.myWindow.TRIANGULAR:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionTriangular(f,c)}return e},this.wFunctionBartlett=function(a,b){return 2/(a-1)*((a-1)/2-Math.abs(b-(a-1)/2))},this.wFunctionBartlettHann=function(b,c){return.62-.48*Math.abs(c/(b-1)-.5)-.38*Math.cos(a.TWO_PI*c/(b-1))},this.wFunctionBlackman=function(b,c,d){var e=(1-d)/2,f=.5,g=d/2;return e-f*Math.cos(a.TWO_PI*c/(b-1))+g*Math.cos(4*a.PI*c/(b-1))},this.wFunctionCosine=function(b,c){return Math.cos(a.PI*c/(b-1)-a.PI/2)},this.wFunctionGauss=function(a,b,c){return Math.pow(Math.E,-.5*Math.pow((b-(a-1)/2)/(c*(a-1)/2),2))},this.wFunctionHamming=function(b,c){return.54-.46*Math.cos(a.TWO_PI*c/(b-1))},this.wFunctionHann=function(b,c){return.5*(1-Math.cos(a.TWO_PI*c/(b-1)))},this.wFunctionLanczos=function(b,c){var d=2*c/(b-1)-1;return Math.sin(a.PI*d)/(a.PI*d)},this.wFunctionRectangular=function(){return 1},this.wFunctionTriangular=function(a,b){return 2/a*(a/2-Math.abs(b-(a-1)/2))},this.applyPreEmph=function(b,c){return b-a.preEmphasisFilterFactor*c},this.fft=function(c,d){var f,g,h,i,j,k,l,m,n,o;for(g=0,j=e/2,f=1;e-1>f;f++){for(i=j;g>=i;)g-=i,i/=2;g+=i,g>f&&(n=c[f],c[f]=c[g],c[g]=n,n=d[f],d[f]=d[g],d[g]=n)}for(i=0,j=1,f=0;b>f;f++)for(i=j,j+=j,k=0,g=0;i>g;g++)for(l=a.cos[k],m=a.sin[k],k+=1<<b-f-1,h=g;e>h;h+=j)n=l*c[h+i]-m*d[h+i],o=m*c[h+i]+l*d[h+i],c[h+i]=c[h]-n,d[h+i]=d[h]-o,c[h]=c[h]+n,d[h]=d[h]+o}},a.convertToHeatmap=function(a,b,c,d){var e=d.length-1,f=(c-a)/(b-a)*e,g=Math.floor(f),h=Math.min.apply(null,[Math.floor(f)+1,e]),i=d[g],j=d[h],k=f-g;return{r:Math.floor(i[0]+k*(j[0]-i[0])),g:Math.floor(i[1]+k*(j[1]-i[1])),b:Math.floor(i[2]+k*(j[2]-i[2]))}},a.drawVerticalLineOfSpectogram=function(b){var c,d,e,f,g=a.pixelHeight,h=2*Math.pow(a.paint[b][1],2)/a.N,i=10*a.log10(h/a.maxPsd),j=(i+a.dynRangeInDB)/a.dynRangeInDB;j>1?j=1:0>j&&(j=0);for(var k=0;k<a.paint[b].length;k++){var l=j;h=2*Math.pow(a.paint[b][k],2)/a.N,i=10*a.log10(h/a.maxPsd),j=(i+a.dynRangeInDB)/a.dynRangeInDB,j>1&&(j=1),0>j&&(j=0);var m=j;if(a.pixelHeight>=1)for(var n=0;n<a.pixelHeight;n++){var o=l+(m-l)/g*n;if(c=255-Math.round(255*o),e=Math.floor(b),f=Math.floor(a.imgHeight-(a.pixelHeight*(k-2)+n)),d=4*(e+f*a.imgWidth),a.drawHeatMapColors)if(isNaN(c))a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency;else{var p=a.convertToHeatmap(0,255,c,a.heatMapColorAnchors);a.resultImgArr[d+0]=p.r,a.resultImgArr[d+1]=p.g,a.resultImgArr[d+2]=p.b,a.resultImgArr[d+3]=a.transparency}else a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency}else c=255-Math.round(255*m),e=Math.floor(b),f=Math.floor(a.imgHeight-a.pixelHeight*(k-2)),d=4*(e+f*a.imgWidth),a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency}},a.calcMagnitudeSpectrum=function(b,c){for(var d=new Float32Array(a.N),e=new Float32Array(a.N),f=new Float32Array(a.ceilingFreqFftIdx-a.floorFreqFftIdx),g=0;c>g;g++)e[g]=a.audioBuffer[b+g];a.myFFT.applyWindowFuncAndPreemph(a.wFunction,a.internalalpha,e,c),a.myFFT.fft(e,d);for(var h=0;h<=a.ceilingFreqFftIdx-a.floorFreqFftIdx;h++)f[h]=a.magnitude(e[h+a.floorFreqFftIdx],d[h+a.floorFreqFftIdx]),a.totalMax<f[h]&&(a.totalMax=f[h]);return f},a.renderSpectrogram=function(){if(!a.executed){a.executed=!0;var b=a.sampleRate*a.windowSizeInSecs;a.myFFT=new a.FFT,a.paint=new Array(a.imgWidth),a.HzStep=a.sampleRate/2/(a.N/2),a.ceilingFreqFftIdx=Math.ceil(a.upperFreq/a.HzStep),a.floorFreqFftIdx=Math.floor(a.lowerFreq/a.HzStep),a.pixelHeight=a.imgHeight/(a.ceilingFreqFftIdx-a.floorFreqFftIdx-2),"undefined"==typeof Uint8ClampedArray&&(Uint8ClampedArray=Uint8Array),a.resultImgArr=new Uint8ClampedArray(Math.ceil(a.imgWidth*a.imgHeight*4));for(var c=0;c<a.imgWidth;c++)a.paint[c]=a.calcMagnitudeSpectrum(Math.round(c*a.samplesPerPxl),b),a.maxPsd=2*Math.pow(a.totalMax,2)/a.N;for(var d=0;d<a.imgWidth;d++)a.drawVerticalLineOfSpectogram(d);a.postMessage({window:a.wFunction,samplesPerPxl:a.samplesPerPxl,pixelHeight:a.pixelHeight,pixelRatio:a.pixelRatio,width:a.imgWidth,height:a.imgHeight,img:a.resultImgArr.buffer},[a.resultImgArr.buffer]),a.myFFT=null,a.executed=!1}},a.onmessage=function(b){if(void 0!==b.data){var c=!0,d="",e=b.data;if(void 0!==e.windowSizeInSecs?a.windowSizeInSecs=e.windowSizeInSecs:(d="windowSizeInSecs",c=!1),void 0!==e.fftN?a.N=e.fftN:(d="fftN",c=!1),void 0!==e.alpha?a.internalalpha=e.alpha:(d="alpha",c=!1),void 0!==e.upperFreq?a.upperFreq=e.upperFreq:(d="upperFreq",c=!1),void 0!==e.lowerFreq?a.lowerFreq=e.lowerFreq:(d="lowerFreq",c=!1),void 0!==e.samplesPerPxl?a.samplesPerPxl=e.samplesPerPxl:(d="samplesPerPxl",c=!1),void 0!==e.window)switch(e.window){case 1:a.wFunction=a.myWindow.BARTLETT;break;case 2:a.wFunction=a.myWindow.BARTLETTHANN;break;case 3:a.wFunction=a.myWindow.BLACKMAN;break;case 4:a.wFunction=a.myWindow.COSINE;break;case 5:a.wFunction=a.myWindow.GAUSS;break;case 6:a.wFunction=a.myWindow.HAMMING;break;case 7:a.wFunction=a.myWindow.HANN;break;case 8:a.wFunction=a.myWindow.LANCZOS;break;case 9:a.wFunction=a.myWindow.RECTANGULAR;break;case 10:a.wFunction=a.myWindow.TRIANGULAR}else d="window",c=!1;void 0!==e.imgWidth?a.imgWidth=e.imgWidth:(d="imgWidth",c=!1),void 0!==e.imgHeight?a.imgHeight=e.imgHeight:(d="imgHeight",c=!1),void 0!==e.dynRangeInDB?a.dynRangeInDB=e.dynRangeInDB:(d="dynRangeInDB",c=!1),void 0!==e.pixelRatio?a.pixelRatio=e.pixelRatio:(d="pixelRatio",c=!1),void 0!==e.sampleRate?a.sampleRate=e.sampleRate:(d="sampleRate",c=!1),void 0!==e.audioBufferChannels?a.audioBufferChannels=e.audioBufferChannels:(d="audioBufferChannels",c=!1),void 0!==e.transparency?a.transparency=e.transparency:(d="transparency",c=!1),void 0!==e.audioBuffer?a.audioBuffer=e.audioBuffer:(d="audioBuffer",c=!1),void 0!==e.drawHeatMapColors?a.drawHeatMapColors=e.drawHeatMapColors:(d="drawHeatMapColors",c=!1),void 0!==e.preEmphasisFilterFactor?a.preEmphasisFilterFactor=e.preEmphasisFilterFactor:(d="preEmphasisFilterFactor",c=!1),void 0!==e.heatMapColorAnchors?a.heatMapColorAnchors=e.heatMapColorAnchors:(d="heatMapColorAnchors",c=!1),c?a.renderSpectrogram():a.postMessage({status:{type:"ERROR",message:d+" is undefined"}})}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to spectroDrawingWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder),a.append(SpectroDrawingWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&("object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.revokeObjectURL(this.url):URL.revokeObjectURL(this.url))},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},angular.module("EMUInterface").controller("MainCtrl",["$scope","$rootScope","bufferService",function(a,b,c){}]),angular.module("EMUInterface").directive("controls",["bufferService","playService","appStateService",function(a,b,c){return{templateUrl:"views/controls.html",restrict:"E",scope:{},link:function(d,e){d.bs=a,d.zoomIn=function(){if(void 0!==c.getStart()&&void 0!==c.getStop()){var a=c.getStop()-c.getStart(),b=3*a/4;c.setStartStop(c.getStart()+.5*(a-b),c.getStop()-.5*(a-b))}},d.zoomOut=function(){if(void 0!==c.getStart()&&void 0!==c.getStop()){var a=c.getStop()-c.getStart(),b=4*a/3;c.setStartStop(c.getStart()-.5*(b-a),c.getStop()+.5*(b-a))}},d.toLeft=function(){if(void 0!==c.getStart()&&void 0!==c.getStop()){var a=c.getStart()-~~((c.getStop()-c.getStart())/4),b=c.getStop()-~~((c.getStop()-c.getStart())/4);a>0?c.setStartStop(a,b):c.setStartStop(0,c.getStop()-c.getStart())}},d.toRight=function(){if(void 0!==c.getStart()&&void 0!==c.getStop()){var a=c.getStart()+~~((c.getStop()-c.getStart())/4),b=c.getStop()+~~((c.getStop()-c.getStart())/4);b<d.bs.audioBuffer.length?c.setStartStop(a,b):c.setStartStop(c.getStart()+(d.bs.audioBuffer.length-c.getStop()),d.bs.audioBuffer.length)}},d.play=function(){void 0!==d.bs.getAudioBuffer()&&b.playFromTo(0,d.bs.getAudioBuffer().length)},d.pauseResume=function(){void 0!==d.bs.getAudioBuffer()&&b.pauseResume()}}}}]),angular.module("EMUInterface").directive("osci",["Drawhelperservice","bufferService","appStateService",function(a,b,c){return{templateUrl:"views/osci.html",restrict:"E",replace:!0,scope:{},link:function(d,e){var f=document.getElementById("osci");d.bs=b,d.ass=c,d.start=void 0,d.stop=void 0,d.$watch("fs.getAudioBuffer()",function(b,c){void 0!==b&&c!==b&&(d.start=0,d.stop=d.bs.getAudioBuffer().length,a.freshRedrawDrawOsciOnCanvas(f,d.start,d.stop,!0))}),d.$watch("ass.getStart()",function(b,c){void 0!==b&&c!==b&&(d.start=d.ass.getStart(),d.stop=d.ass.getStop(),a.freshRedrawDrawOsciOnCanvas(f,d.start,d.stop,!0))}),d.$watch("ass.getStop()",function(b,c){void 0!==b&&c!==b&&(d.start=d.ass.getStart(),d.stop=d.ass.getStop(),a.freshRedrawDrawOsciOnCanvas(f,d.start,d.stop,!0))})}}}]),angular.module("EMUInterface").directive("spectro",["Drawhelperservice","bufferService","mathHelperService","appStateService",function(a,b,c,d){return{templateUrl:"views/spectro.html",restrict:"E",replace:!0,scope:{},link:function(e,f){e.bs=b,e.ass=d,e.dhs=a,e.canvas=document.getElementById("spectro"),e.context=e.canvas.getContext("2d"),e.alpha=.16,e.devicePixelRatio=window.devicePixelRatio||1,e.primeWorker=new SpectroDrawingWorker,e.start=void 0,e.stop=void 0,e.$watch("fs.getAudioBuffer()",function(a,b){void 0!==a&&b!==a&&(e.start=0,e.stop=e.bs.getAudioBuffer().length,e.redraw())}),e.$watch("ass.getStart()",function(a,b){void 0!==a&&b!==a&&(e.start=e.ass.getStart(),e.stop=e.ass.getStop(),e.redraw())}),e.$watch("ass.getStop()",function(a,b){void 0!==a&&b!==a&&(e.start=e.ass.getStart(),e.stop=e.ass.getStop(),e.redraw())}),e.redraw=function(){e.context.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawSpectro(e.bs.audioBuffer.getChannelData(0))},e.drawSpectro=function(a){e.killSpectroRenderingThread(),e.startSpectroRenderingThread(a)},e.calcSamplesPerPxl=function(){return(e.stop+1-e.start)/e.canvas.width},e.killSpectroRenderingThread=function(){e.context.fillStyle="#E7E7E7",e.context.fillRect(0,0,e.canvas.width,e.canvas.height),null!==e.primeWorker&&(e.primeWorker.kill(),e.primeWorker=null)},e.setupEvent=function(){var a=e.context.createImageData(e.canvas.width,e.canvas.height);e.primeWorker.says(function(b){if(void 0===b.status){if(e.calcSamplesPerPxl()===b.samplesPerPxl){var c=new Uint8ClampedArray(b.img);a.data.set(c),e.context.putImageData(a,0,0)}}else console.error("Error rendering spectrogram:",b.status.message)})},e.startSpectroRenderingThread=function(a){if(a.length>0){e.primeWorker=new SpectroDrawingWorker;var b=[],d=c.calcClosestPowerOf2Gt(.01*e.bs.audioBuffer.sampleRate);512>d&&(d=512),b=a.subarray(e.start,e.stop);var f=[],g=[],h=e.bs.audioBuffer.length;h/2>0||(f=a.subarray(0-h/2,0)),e.bs.audioBuffer.length+d/2-1>=e.bs.audioBuffer.length||(g=a.subarray(e.bs.audioBuffer.length,e.bs.audioBuffer.length+d/2-1));var i=new Float32Array(f.length+b.length+g.length);i.set(f),i.set(b,f.length),i.set(g,f.length+b.length),e.setupEvent(),e.primeWorker.tell({windowSizeInSecs:.01,fftN:d,alpha:e.alpha,upperFreq:5e3,lowerFreq:0,samplesPerPxl:e.calcSamplesPerPxl(),window:5,imgWidth:e.canvas.width,imgHeight:e.canvas.height,dynRangeInDB:70,pixelRatio:e.devicePixelRatio,sampleRate:e.bs.audioBuffer.sampleRate,transparency:255,audioBuffer:i,audioBufferChannels:1,drawHeatMapColors:!1,preEmphasisFilterFactor:.97,heatMapColorAnchors:[[255,0,0],[0,255,0],[0,0,0]]},[i.buffer])}}}}}]),angular.module("EMUInterface").service("bufferService",["$rootScope","Wavparserservice","browserDetector","appStateService",function(a,b,c,d){var e={};return e.audioBuffer=void 0,e.setAudioBufferFromArray=function(a){b.parseWavAudioBuf(a).then(function(a){e.setAudioBuffer(a),d.setMinMax(0,a.length),d.setStartStop(0,a.length)},function(a){console.log("Erreur "+a)})},e.ArrayBufferToBASE64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);var f=window.btoa(b);return f},e.BASE64ToArrayBuffer=function(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return d.buffer},e.setAudioBuffer=function(b){e.audioBuffer=b,d.setMinMax(0,e.audioBuffer.length),d.setStartStop(0,e.audioBuffer.length),a.$apply()},e.getAudioBuffer=function(){return e.audioBuffer},e}]),angular.module("EMUInterface").service("Wavparserservice",["$q",function(a){var b,c={};return c.ab2str=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return String.fromCharCode.apply(null,b)},c.parseWavHeader=function(a){var b,d,e,f={};if(b=0,d=a.subarray(b,4),e=new Uint8Array(d),f.ChunkID=c.ab2str(e),"RIFF"!==f.ChunkID)return{status:{type:"ERROR",message:"Wav read error: ChunkID not RIFF but "+f.ChunkID}};if(b=4,d=a.subarray(b,4),e=new Uint32Array(d),f.ChunkSize=e[0],b=8,d=a.subarray(b,4),e=new Uint8Array(d),f.Format=c.ab2str(e),"WAVE"!==f.Format)return{status:{type:"ERROR",message:"Wav read error: Format not WAVE but "+f.Format}};if(b=12,d=a.subarray(b,4),e=new Uint8Array(d),f.Subchunk1ID=c.ab2str(e),-1===["fmt ","bext"].indexOf(f.Subchunk1ID))return{status:{type:"ERROR",message:"Wav read error: Subchunk1ID not fmt  but "+f.Subchunk1ID}};if(b=16,d=a.subarray(b,4),e=new Uint32Array(d),f.Subchunk1Size=e[0],-1===[16,18,40].indexOf(f.Subchunk1Size))return{status:{type:"ERROR",message:"Wav read error: Subchunk1Size not 16, 18 or 40 but "+f.Subchunk1Size}};if(40!==f.Subchunk1Size&&(b=20,d=a.subarray(b,2),e=new Uint16Array(d),f.AudioFormat=e[0],-1===[0,1].indexOf(f.AudioFormat)))return{status:{type:"ERROR",message:"Wav read error: AudioFormat not 0 or 1 but "+f.AudioFormat}};if(b=22,d=a.subarray(b,2),e=new Uint16Array(d),f.NumChannels=e[0],f.NumChannels<1)return{status:{type:"ERROR",message:"Wav read error: NumChannels not greater than 1 but "+f.NumChannels}};b=24,d=a.subarray(b,4),e=new Uint32Array(d),f.SampleRate=e[0],b=28,d=a.subarray(b,4),e=new Uint32Array(d),f.ByteRate=e[0],b=32,d=a.subarray(b,2),e=new Uint16Array(d),f.BlockAlign=e[0],b=34,d=a.subarray(b,2),e=new Uint16Array(d),f.BitsPerSample=e[0];var g=!1;for(b=36;!g;){d=a.subarray(b,4),e=new Uint8Array(d);var h=c.ab2str(e);"data"===h?(g=!0,d=a.subarray(b+4,4),e=new Uint32Array(d),f.dataChunkSize=e[0]):b+=1}return f},c.parseWavAudioBuf=function(d){var e=c.parseWavHeader(d);if("undefined"!=typeof e.status&&"ERROR"===e.status.type)return b=a.defer(),b.reject(e),b.promise;try{var f=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(e.NumChannels,e.dataChunkSize/e.NumChannels/(e.BitsPerSample/8),e.SampleRate);return f.decodeAudioData(d)}catch(g){var h={};h.exception=JSON.stringify(g,null,4),h.EMUwebAppComment="This could be because you are using Safari and the sample rate is unequal to 44100; 48000 or 96000 which seem to currently be the only sample rates supported by the webkitOfflineAudioContext in Safari";var i={};return i.status={},i.status.message=JSON.stringify(h,null,4),b=a.defer(),b.reject(i),b.promise}},c}]),angular.module("EMUInterface").factory("browserDetector",function(){var a={};return a.isMobile={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return a.isMobile.Android()||a.isMobile.BlackBerry()||a.isMobile.iOS()||a.isMobile.Opera()||a.isMobile.Windows()}},a.isBrowser={Firefox:function(){return navigator.userAgent.match(/Firefox/i)},Chrome:function(){return navigator.userAgent.match(/Chrome/i)},InternetExplorer:function(){return navigator.userAgent.match(/MSIE/i)},Opera:function(){return navigator.userAgent.match(/Opera/i)},PhantomJS:function(){return navigator.userAgent.match(/PhantomJS/i)},Safari:function(){return Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0},any:function(){return a.isBrowser.Firefox()||a.isBrowser.Chrome()||a.isBrowser.InternetExplorer()||a.isBrowser.Opera()||a.isBrowser.Safari()||a.isBrowser.PhantomJS()}},a.isMobileDevice=function(){var b=a.isMobile.any();return null===b?!1:b.length>0?!0:!1},a.isDesktopDevice=function(){var b=a.isBrowser.any();return null===b?!1:b.length>0?!0:!1},a}),angular.module("EMUInterface").service("Drawhelperservice",["bufferService","mathHelperService",function(a,b){var c={};return c.bs=a,c.osciPeaks={},c.calculateOsciPeaks=function(){var a=c.bs.audioBuffer.sampleRate,b=c.bs.audioBuffer.numberOfChannels,d=a/400,e=a/10,f=a/1;c.osciPeaks={numberOfChannels:b,sampleRate:a,winSizes:[d,e,f],channelOsciPeaks:[]};for(var g=0;b>g;g++){for(var h=c.bs.audioBuffer.getChannelData(g),i=new Float32Array(Math.round(c.bs.audioBuffer.length/d)),j=new Float32Array(Math.round(c.bs.audioBuffer.length/d)),k=new Float32Array(Math.round(c.bs.audioBuffer.length/e)),l=new Float32Array(Math.round(c.bs.audioBuffer.length/e)),m=new Float32Array(Math.round(c.bs.audioBuffer.length/f)),n=new Float32Array(Math.round(c.bs.audioBuffer.length/f)),o=0,p=0,q=1/0,r=-(1/0),s=0,t=0,u=1/0,v=-(1/0),w=0,x=0,y=1/0,z=-(1/0),A=0;A<=h.length;A++)h[A]>r&&(r=h[A]),h[A]<q&&(q=h[A]),h[A]>v&&(v=h[A]),h[A]<u&&(u=h[A]),h[A]>z&&(z=h[A]),h[A]<y&&(y=h[A]),o===Math.round(d)&&(i[p]=r,j[p]=q,p+=1,o=0,q=1/0,r=-(1/0)),s===Math.round(e)&&(k[t]=v,l[t]=u,t+=1,s=0,u=1/0,v=-(1/0)),w===Math.round(f)&&(m[x]=z,n[x]=y,x+=1,w=0,y=1/0,z=-(1/0)),o+=1,s+=1,w+=1;c.osciPeaks.channelOsciPeaks[g]={maxPeaks:[i,k,m],minPeaks:[j,l,n]}}},c.calculatePeaks=function(a,b,c,d){var e,f,g,h,i,j=(d+1-c)/a.width,k=[],l=[],m=[],n=1/0,o=-(1/0),p=1/0,q=-(1/0);if(1>=j)i=0===c?b.subarray(c,d+2):b.subarray(c-1,d+2),e=Math.min.apply(Math,i),f=Math.max.apply(Math,i),k=Array.prototype.slice.call(i);else{i=b.subarray(c,d),l=new Float32Array(a.width),m=new Float32Array(a.width);for(var r=0;r<a.width;r++){g=r*j-j/2,h=r*j+j/2,0>g&&(g=0);var s=i.subarray(g,h);p=1/0,q=-(1/0);for(var t=0;t<s.length;t++)s[t]>q&&(q=s[t]),s[t]<p&&(p=s[t]);l[r]=q,m[r]=p,q>o&&(o=q),n>p&&(n=p)}}return{samples:k,minSample:e,maxSample:f,minPeaks:m,maxPeaks:l,minMinPeak:n,maxMaxPeak:o,samplePerPx:j}},c.calcSampleTime=function(a){return a/c.bs.audioBuffer.sampleRate+.5/c.bs.audioBuffer.sampleRate},c.getCurrentSample=function(a){return c.bs.getAudioBuffer().length*a},c.getSampleDist=function(a){return this.getPos(a,1)-this.getPos(a,0)},c.getPos=function(a,b){return a*(b-0)/(c.bs.getAudioBuffer().length-0+1)},c.findMinMaxPeaks=function(a,b,d){for(var e=c.calcSampleTime(a),f=c.calcSampleTime(b),g=c.osciPeaks.sampleRate/c.osciPeaks.winSizes[d],h=e*g,i=f*g,j=1/0,k=-(1/0),l=Math.round(h);l<Math.round(i);l++)c.osciPeaks.channelOsciPeaks[0].maxPeaks[d][l]>k&&(k=c.osciPeaks.channelOsciPeaks[0].maxPeaks[d][l]),c.osciPeaks.channelOsciPeaks[0].minPeaks[d][l]<j&&(j=c.osciPeaks.channelOsciPeaks[0].minPeaks[d][l]);return{minMinPeak:j,maxMaxPeak:k}},c.freshRedrawDrawOsciOnCanvas=function(a,b,d,e){var f=a.getContext("2d");f.clearRect(0,0,a.width,a.height),e&&(c.osciPeaks={}),angular.equals({},c.osciPeaks)&&c.calculateOsciPeaks();var g,h=(d+1-b)/a.width,i=-1;for(g=0;g<c.osciPeaks.winSizes.length;g++)h>c.osciPeaks.winSizes[g]&&(i=g);var j,k,l,m,n;if(-1!==i){j=c.findMinMaxPeaks(b,d,i);var o=c.calcSampleTime(b),p=c.osciPeaks.sampleRate/c.osciPeaks.winSizes[i],q=o*p,r=Math.round(q);f.beginPath(),k=(j.maxMaxPeak-c.osciPeaks.channelOsciPeaks[0].maxPeaks[i][r])/(j.maxMaxPeak-j.minMinPeak)*a.height,l=(j.maxMaxPeak-c.osciPeaks.channelOsciPeaks[0].minPeaks[i][r])/(j.maxMaxPeak-j.minMinPeak)*a.height,f.moveTo(0,k),m=k,n=l;for(var s,t,u,v=1;v<a.width;v++)t=v/a.width,u=c.getCurrentSample(t),s=c.calcSampleTime(u),r=Math.round(s*p),k=(j.maxMaxPeak-c.osciPeaks.channelOsciPeaks[0].maxPeaks[i][r])/(j.maxMaxPeak-j.minMinPeak)*a.height,l=(j.maxMaxPeak-c.osciPeaks.channelOsciPeaks[0].minPeaks[i][r])/(j.maxMaxPeak-j.minMinPeak)*a.height,f.moveTo(v-1,m),f.lineTo(v-1,k),f.moveTo(v-1,n),f.lineTo(v-1,l),f.moveTo(v,k),f.lineTo(v,l),m=k,n=l;f.stroke()}else if(j=c.calculatePeaks(a,c.bs.audioBuffer.getChannelData(0),b,d),j.minPeaks&&j.maxPeaks&&j.samplePerPx>=1){for(f.strokeStyle="#000000",f.beginPath(),k=(j.maxMaxPeak-j.maxPeaks[0])/(j.maxMaxPeak-j.minMinPeak)*a.height,l=(j.maxMaxPeak-j.minPeaks[0])/(j.maxMaxPeak-j.minMinPeak)*a.height,f.moveTo(0,k),f.lineTo(0,l),m=k,n=l,g=1;g<a.width;g++)k=(j.maxMaxPeak-j.maxPeaks[g])/(j.maxMaxPeak-j.minMinPeak)*a.height,l=(j.maxMaxPeak-j.minPeaks[g])/(j.maxMaxPeak-j.minMinPeak)*a.height,f.moveTo(g-1,m),f.lineTo(g-1,k),f.moveTo(g-1,n),f.lineTo(g-1,l),f.moveTo(g,k),f.lineTo(g,l),m=k,n=l;f.stroke()}else if(j.samplePerPx<1){var w=1/j.samplePerPx/2,x=0;if(f.strokeStyle="#000000",f.fillStyle="#000000",0===x){for(f.moveTo(w,(j.samples[0]-j.minSample)/(j.maxSample-j.minSample)*a.height),g=0;g<j.samples.length;g++)f.lineTo(g/j.samplePerPx+w,(j.samples[g]-j.minSample)/(j.maxSample-j.minSample)*a.height);for(f.stroke(),g=0;g<j.samples.length;g++)f.beginPath(),f.arc(g/j.samplePerPx+w,(j.samples[g]-j.minSample)/(j.maxSample-j.minSample)*a.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill()}else{for(f.beginPath(),f.moveTo(-w,a.height-(j.samples[0]-j.minSample)/(j.maxSample-j.minSample)*a.height),g=1;g<=j.samples.length;g++)f.lineTo(g/j.samplePerPx-w,a.height-((j.samples[g]-j.minSample)/(j.maxSample-j.minSample)*a.height+3));for(f.stroke(),g=1;g<=j.samples.length;g++)f.beginPath(),f.arc(g/j.samplePerPx-w,a.height-(j.samples[g]-j.minSample)/(j.maxSample-j.minSample)*a.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill()}}},c.drawMovingBoundaryLine=function(a){var b,d;d=c.getSampleDist(a.canvas.width),b=d/2},c.drawMinMaxAndName=function(a,b,c,d,e){a.strokeStyle="#000000",a.fillStyle="#000000",a.beginPath(),a.moveTo(0,0),a.lineTo(5,5),a.moveTo(0,a.canvas.height),a.lineTo(5,a.canvas.height-5),a.stroke(),a.closePath()},c.drawCurViewPortSelected=function(a,b){var d,e;e=c.getSampleDist(a.canvas.width),d=0;var f=c.getPos(a.canvas.width,0),g=c.getPos(a.canvas.width,c.bs.audioBuffer.length);f===g?(a.fillStyle="rgba(0, 0, 0, 255)",a.fillRect(f+d,0,2,a.canvas.height)):(a.fillStyle="rgba(150, 150, 150, 0.5)",a.fillRect(f,0,g-f,a.canvas.height),a.fillStyle="rgba(0, 0, 0, 0.5)",a.beginPath(),a.moveTo(f,0),a.lineTo(f,a.canvas.height),a.moveTo(g,0),a.lineTo(g,a.canvas.height),a.closePath(),a.stroke())},c}]),angular.module("EMUInterface").service("mathHelperService",function(){var a={};return a.calcClosestPowerOf2Gt=function(a){for(var b=0;Math.pow(2,b)<a;)b+=1;return Math.pow(2,b)},a.roundToNdigitsAfterDecPoint=function(a,b){(1>b||b>14)&&console.error("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),parseFloat(d.substring(0,d.indexOf(".")+b+1))},a}),angular.module("EMUInterface").factory("playService",["bufferService",function(a){function b(){try{window.AudioContext=window.AudioContext||window.webkitAudioContext,d=new AudioContext}catch(a){alert("Error loading the AudioContext (could mean your browser does not support the HTML5 webaudio API):"+a)}}var c,d,e={};return e.bs=a,e.isPlaying=!1,e.playFromTo=function(a,f){"undefined"==typeof d&&b(),e.isPlaying?(e.isPlaying=!1,c.stop(0)):"undefined"==typeof c?e.bs.getAudioBuffer().length>0&&(e.isPlaying=!0,e.decodeAndPlay(a,f)):"suspended"==d.state?(e.isPlaying=!0,d.resume()):(e.isPlaying=!0,e.decodeAndPlay(a,f))},e.decodeAndPlay=function(a,b){var f=e.bs.getAudioBuffer();if(void 0!==f){var g=a/f.sampleRate,h=b/f.sampleRate,i=h-g;c=d.createBufferSource(),c.buffer=f,c.connect(d.destination),c.start(0,g,i),c.onended=function(){e.isPlaying=!1}}},e.pauseResume=function(){"undefined"!=typeof d&&(e.isPlaying?(e.isPlaying=!1,d.suspend()):"suspended"==d.state&&(e.isPlaying=!0,d.resume()))},e}]),angular.module("EMUInterface").factory("appStateService",["$rootScope",function(a){var b={};return b.startSignal=void 0,b.stopSignal=void 0,b.startMin=void 0,b.stopMax=void 0,b.setStartStop=function(a,c){a<b.startMin&&(a=0),c>b.stopMax&&(c=b.stopMax),b.startSignal=a,b.stopSignal=c},b.setMinMax=function(a,c){b.startMin=a,b.stopMax=c},b.getStart=function(){return b.startSignal},b.getStop=function(){return b.stopSignal},b}]),ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("EMUInterface").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/controls.html",'<div id="controls"> <input type="button" value="in" ng-click="zoomIn()"> <input type="button" value="out" ng-click="zoomOut()"> <input type="button" value="left" ng-click="toLeft()"> <input type="button" value="right" ng-click="toRight()"> <input type="button" value="play" ng-click="play()"> <input type="button" value="pause/resume" ng-click="pauseResume()"> </div>'),a.put("views/main.html","<div> <osci></osci> <spectro></spectro> <mydropzone></mydropzone> <controls></controls> </div>"),a.put("views/osci.html",'<div> <canvas id="osci" width="2048" style="width: 100%"></canvas> </div>'),a.put("views/spectro.html",'<div> <canvas id="spectro" width="2048" style="width: 100%"></canvas> </div>')}]);